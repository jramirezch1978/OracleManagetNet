@page "/"
@using OracleDBManager.Core.Interfaces
@using OracleDBManager.Core.Models
@using OracleDBManager.Infrastructure.Configuration
@inject ILockService LockService
@inject NavigationManager Navigation
@inject OracleConfiguration OracleConfig
@rendermode InteractiveServer

<PageTitle>Inicio - Oracle Database Manager</PageTitle>

<div class="page-header mb-4">
    <h2><i class="fas fa-dashboard"></i> Panel de Control</h2>
</div>

<div class="row">
    <div class="col-md-6 col-lg-3 mb-4">
        <div class="card">
            <div class="card-body text-center">
                <i class="fas fa-lock fa-3x text-warning mb-3"></i>
                <h5 class="card-title">Bloqueos Activos</h5>
                <h2 class="text-primary">@activeLocks</h2>
                <a href="/locks" class="btn btn-sm btn-primary mt-2">Ver Bloqueos</a>
            </div>
        </div>
    </div>
    
    <div class="col-md-6 col-lg-3 mb-4">
        <div class="card">
            <div class="card-body text-center">
                <i class="fas fa-ban fa-3x text-danger mb-3"></i>
                <h5 class="card-title">Sesiones Bloqueadas</h5>
                <h2 class="text-danger">@blockedSessions</h2>
                <a href="/locks" class="btn btn-sm btn-danger mt-2">Ver Detalles</a>
            </div>
        </div>
    </div>
    
    <div class="col-md-6 col-lg-3 mb-4">
        <div class="card">
            <div class="card-body text-center">
                <i class="fas fa-database fa-3x text-success mb-3"></i>
                <h5 class="card-title">Estado Base de Datos</h5>
                <h2 class="text-success">@(isConnected ? "Conectado" : "Desconectado")</h2>
                <button class="btn btn-sm btn-success mt-2" @onclick="ShowConnectionModal">Probar Conexión</button>
            </div>
        </div>
    </div>
    
    <div class="col-md-6 col-lg-3 mb-4">
        <div class="card">
            <div class="card-body text-center">
                <i class="fas fa-server fa-3x text-info mb-3"></i>
                <h5 class="card-title">Servidor Oracle</h5>
                <p class="text-muted">192.168.0.159:1521</p>
                <p class="text-muted">HADES</p>
            </div>
        </div>
    </div>
</div>

<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-info-circle"></i> Información del Sistema</h5>
            </div>
            <div class="card-body">
                <p>Bienvenido a Oracle Database Manager, una herramienta similar a Oracle Enterprise Manager para gestionar y monitorear tu base de datos Oracle.</p>
                <h6>Características principales:</h6>
                <ul>
                    <li>Gestión de bloqueos de base de datos</li>
                    <li>Monitoreo de sesiones activas</li>
                    <li>Terminación de sesiones problemáticas</li>
                    <li>Visualización en tiempo real</li>
                    <li>Integración con Active Directory</li>
                </ul>
            </div>
        </div>
    </div>
</div>

@* Modal de Configuración de Conexión *@
@if (showConnectionModal)
{
    <div class="oracle-modal">
        <div class="oracle-modal-content" style="max-width: 600px;">
            <div class="oracle-modal-header">
                <i class="fas fa-database"></i> Configuración de Conexión Oracle
            </div>
            <div class="oracle-modal-body">
                <div class="mb-3">
                    <label class="form-label">Host:</label>
                    <input type="text" class="form-control" @bind="connectionModel.Host" />
                </div>
                <div class="mb-3">
                    <label class="form-label">Puerto:</label>
                    <input type="text" class="form-control" @bind="connectionModel.Port" />
                </div>
                <div class="mb-3">
                    <label class="form-label">Nombre del Servicio (SID):</label>
                    <input type="text" class="form-control" @bind="connectionModel.ServiceName" />
                </div>
                <div class="mb-3">
                    <label class="form-label">Usuario:</label>
                    <input type="text" class="form-control" @bind="connectionModel.UserId" />
                </div>
                <div class="mb-3">
                    <label class="form-label">Contraseña:</label>
                    <input type="password" class="form-control" @bind="connectionModel.Password" />
                </div>
                
                @if (isTestingConnection)
                {
                    <div class="text-center">
                        <div class="oracle-spinner"></div>
                        <p>Probando conexión...</p>
                    </div>
                }
            </div>
            <div class="oracle-modal-footer">
                <button class="oracle-button" @onclick="CloseConnectionModal" disabled="@isTestingConnection">Cancelar</button>
                <button class="oracle-button oracle-button-primary" @onclick="TestConnectionWithParams" disabled="@isTestingConnection">
                    <i class="fas fa-plug"></i> Conectar
                </button>
            </div>
        </div>
    </div>
}

@* Modal de Resultado de Conexión *@
@if (showResultModal)
{
    <div class="oracle-modal" style="z-index: 1100;">
        <div class="oracle-modal-content" style="max-width: 400px;">
            <div class="oracle-modal-header">
                @if (connectionSuccess)
                {
                    <i class="fas fa-check-circle text-success"></i>
                    <span class="text-success"> Conexión Exitosa</span>
                }
                else
                {
                    <i class="fas fa-times-circle text-danger"></i>
                    <span class="text-danger"> Error de Conexión</span>
                }
            </div>
            <div class="oracle-modal-body text-center">
                @if (connectionSuccess)
                {
                    <i class="fas fa-check-circle fa-5x text-success mb-3"></i>
                    <h5>¡Conexión establecida satisfactoriamente!</h5>
                    <p>La conexión a la base de datos Oracle se ha realizado correctamente.</p>
                }
                else
                {
                    <i class="fas fa-times-circle fa-5x text-danger mb-3"></i>
                    <h5>No se pudo establecer la conexión</h5>
                    <p class="text-danger">@connectionErrorMessage</p>
                }
            </div>
            <div class="oracle-modal-footer">
                <button class="oracle-button" @onclick="CloseResultModal">Aceptar</button>
            </div>
        </div>
    </div>
}

@code {
    private int activeLocks = 0;
    private int blockedSessions = 0;
    private bool isConnected = false;
    
    // Estados para los modales
    private bool showConnectionModal = false;
    private bool showResultModal = false;
    private bool isTestingConnection = false;
    private bool connectionSuccess = false;
    private string? connectionErrorMessage;
    
    // Modelo para los datos de conexión
    private ConnectionTestModel connectionModel = new();

    protected override async Task OnInitializedAsync()
    {
        await LoadDashboardData();
        LoadConnectionSettings();
    }

    private void LoadConnectionSettings()
    {
        // Cargar valores desde la configuración
        if (!string.IsNullOrEmpty(OracleConfig.DataSource))
        {
            // Extraer host, puerto y servicio del DataSource
            var match = System.Text.RegularExpressions.Regex.Match(
                OracleConfig.DataSource, 
                @"HOST=([^)]+)\).*PORT=(\d+)\).*SERVICE_NAME=([^)]+)\)"
            );
            
            if (match.Success)
            {
                connectionModel.Host = match.Groups[1].Value;
                connectionModel.Port = match.Groups[2].Value;
                connectionModel.ServiceName = match.Groups[3].Value;
            }
        }
        
        connectionModel.UserId = OracleConfig.UserId;
        connectionModel.Password = OracleConfig.Password;
    }

    private async Task LoadDashboardData()
    {
        try
        {
            // Probar conexión
            isConnected = await LockService.TestDatabaseConnectionAsync();
            
            if (isConnected)
            {
                // Obtener datos de bloqueos
                var locks = await LockService.GetAllLocksAsync();
                activeLocks = locks.Count;
                blockedSessions = locks.Count(l => l.IsBlocked);
            }
        }
        catch
        {
            isConnected = false;
        }
    }

    private void ShowConnectionModal()
    {
        showConnectionModal = true;
        LoadConnectionSettings(); // Recargar valores actuales
    }

    private void CloseConnectionModal()
    {
        showConnectionModal = false;
        isTestingConnection = false;
    }

    private async Task TestConnectionWithParams()
    {
        try
        {
            isTestingConnection = true;
            StateHasChanged();
            
            // Simular delay para mostrar el spinner
            await Task.Delay(1000);
            
            // Aquí normalmente probarías la conexión con los parámetros específicos
            // Por ahora usamos la conexión configurada
            connectionSuccess = await LockService.TestDatabaseConnectionAsync();
            
            if (!connectionSuccess)
            {
                connectionErrorMessage = "No se pudo conectar a la base de datos. Verifique los parámetros de conexión.";
            }
        }
        catch (Exception ex)
        {
            connectionSuccess = false;
            connectionErrorMessage = ex.Message;
        }
        finally
        {
            isTestingConnection = false;
            showResultModal = true;
            StateHasChanged();
        }
    }

    private async Task CloseResultModal()
    {
        showResultModal = false;
        
        if (connectionSuccess)
        {
            showConnectionModal = false;
            await LoadDashboardData(); // Recargar datos si la conexión fue exitosa
        }
    }
}
